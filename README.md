# Typecho 多吉云 URL 鉴权插件

一个为 Typecho 博客系统设计的多吉云 CDN URL 鉴权插件，支持自动为静态资源添加鉴权参数，并提供智能的自动刷新机制。
** 本人博客：** [https://www.uomn.cn](https://www.uomn.cn)


## 📋 功能特性

### 🔐 核心功能
- **URL 鉴权**: 自动为图片、CSS、JS 等静态资源添加多吉云格式的鉴权参数
- **灵活配置**: 支持多域名配置，可针对不同域名设置不同的鉴权密钥
- **文件类型过滤**: 可自定义需要鉴权的文件扩展名
- **Service Worker**: 利用 Service Worker 技术拦截网络请求，确保鉴权的完整性

### 🚀 自动刷新机制（新增）
- **智能过期检测**: 自动检测页面中即将过期的鉴权URL（提前5分钟）
- **无缝刷新**: 在鉴权参数过期前自动生成新的鉴权URL并替换
- **全面覆盖**: 支持图片、CSS背景图片等所有资源的自动刷新
- **定期检查**: 每5分钟自动扫描页面中的资源链接
- **错误重试**: 图片加载失败时自动重试，最多3次
- **智能重试间隔**: 采用递增延迟策略（1秒、2秒、3秒）

## 🛠️ 安装方法

### 1. 下载插件
将插件文件夹 `DogeCloudAuth` 上传到 Typecho 的 `usr/plugins/` 目录下。

### 2. 启用插件
1. 登录 Typecho 后台
2. 进入「控制台」→「插件管理」
3. 找到「多吉云URL鉴权」插件
4. 点击「启用」

### 3. 配置插件
启用后进入插件设置页面，配置以下参数：

## ⚙️ 配置说明

### 基本配置

#### 域名和密钥配置
```
格式：域名:密钥
示例：
cdn.example.com:your_secret_key_1
static.example.com:your_secret_key_2
```

#### 文件扩展名配置
```
格式：扩展名用逗号分隔
默认：jpg,jpeg,png,gif,webp,css,js
示例：jpg,png,gif,css,js,mp4,pdf
```

#### 鉴权有效期
- **推荐设置**: 30分钟（1800秒）
- **最小值**: 300秒（5分钟）
- **最大值**: 86400秒（24小时）

### 高级配置

#### Service Worker 路径
- **默认**: `/sw.js`
- **说明**: Service Worker 脚本的访问路径
- **注意**: 确保路径不与现有文件冲突

## 🔍 鉴权原理

### 算法说明
本插件采用多吉云标准的 URL 鉴权算法：

1. **参数构成**:
   - `auth_key`: 鉴权密钥的 MD5 值
   - `timestamp`: 过期时间戳

2. **生成步骤**:
   ```
   原始URL: https://cdn.example.com/image.jpg
   密钥: your_secret_key
   有效期: 1800秒
   
   计算过程:
   1. 提取URI路径: /image.jpg
   2. 计算过期时间: current_time + 1800
   3. 生成随机字符串: random_string
   4. 计算MD5: md5(secret_key + uri + timestamp + random_string)
   5. 最终URL: https://cdn.example.com/image.jpg?auth_key=md5_value&timestamp=expire_time
   ```

### 工作流程

1. **页面加载时**: 插件扫描页面中的静态资源链接
2. **URL 替换**: 为匹配的资源添加鉴权参数
3. **Service Worker**: 拦截网络请求，确保鉴权参数正确
4. **自动刷新**: 定期检查并刷新即将过期的鉴权URL
5. **错误处理**: 处理鉴权失败和网络错误

## 🌐 多吉云配置指南

### 1. 多吉云控制台设置

1. 登录多吉云控制台
2. 进入「CDN」→「域名管理」
3. 选择需要配置的域名
4. 进入「访问控制」→「URL鉴权」
5. 启用 URL 鉴权功能
6. 设置鉴权密钥（与插件配置保持一致）
7. 配置鉴权参数名称：
   - 鉴权 KEY: `auth_key`
   - 时间戳: `timestamp`

### 2. 鉴权规则配置

- **鉴权类型**: 选择「TypeA」
- **鉴权范围**: 根据需要选择文件类型
- **有效时间**: 与插件设置保持一致
- **鉴权算法**: 使用默认算法

### 3. 缓存配置建议

- **静态资源缓存**: 建议设置较长的缓存时间
- **鉴权参数**: 不要缓存包含鉴权参数的URL
- **源站配置**: 确保源站支持鉴权参数透传

## 🔧 技术实现

### Plugin.php 核心功能

- `activate()`: 插件激活时注册钩子
- `deactivate()`: 插件禁用时清理钩子和路由
- `processPageOutput()`: 处理页面输出，添加鉴权参数
- `processHtmlUrls()`: 处理HTML中的资源链接
- `processCssUrls()`: 处理CSS中的背景图片链接
- `injectServiceWorker()`: 注入Service Worker和自动刷新脚本
- `generateAuthUrl()`: 生成鉴权URL
- `getAutoRefreshScript()`: 生成自动刷新JavaScript代码

### ServiceWorker.php 增强功能

- `fetch` 事件处理: 拦截网络请求并添加鉴权
- `handleAuthRequest()`: 异步处理鉴权请求
- 重试机制: 请求失败时自动重试
- 错误恢复: 检测鉴权失败并重新生成URL
- 客户端通信: 支持与页面脚本的消息传递

### 自动刷新机制

#### 客户端脚本功能
- **定期检查**: 每5分钟检查一次页面中的鉴权URL
- **过期预测**: 提前5分钟检测即将过期的URL
- **URL替换**: 自动替换页面中的过期URL
- **图片重载**: 重新加载更新后的图片资源
- **错误重试**: 加载失败时的智能重试机制

#### Service Worker 协同
- **请求拦截**: 拦截所有静态资源请求
- **鉴权检查**: 检查请求URL的鉴权状态
- **动态生成**: 为过期或无鉴权的URL动态生成鉴权参数
- **缓存管理**: 避免缓存过期的鉴权URL

## 🐛 故障排除

### 常见问题

#### 1. 图片不显示或显示403错误
**可能原因**:
- 鉴权密钥配置错误
- 多吉云控制台鉴权设置不正确
- 域名配置不匹配

**解决方法**:
1. 检查插件配置中的域名和密钥是否正确
2. 确认多吉云控制台的鉴权设置
3. 查看浏览器开发者工具的网络请求

#### 2. Service Worker 无法正常工作
**可能原因**:
- 网站未使用HTTPS（生产环境）
- Service Worker路径冲突
- 浏览器不支持Service Worker

**解决方法**:
1. 确保生产环境使用HTTPS
2. 修改Service Worker路径配置
3. 检查浏览器兼容性

#### 3. 自动刷新功能不工作
**可能原因**:
- JavaScript被禁用或阻止
- 控制台出现错误
- 网络连接问题

**解决方法**:
1. 检查浏览器控制台是否有错误信息
2. 确认JavaScript正常执行
3. 检查网络连接状态

### 调试信息

#### 浏览器控制台日志
```
[DogeCloud] 开始检查过期的鉴权URL - 定期检查开始
[DogeCloud] 发现即将过期的URL: xxx - 检测到需要刷新的URL
[DogeCloud] URL刷新成功: xxx - 刷新成功
[DogeCloud] 图片重新加载成功: xxx - 重试成功
[DogeCloud] 图片加载失败，开始重试 - 重试开始
```

#### Service Worker 日志
```
鉴权失败，重新生成鉴权URL - 检测到鉴权过期
Service Worker请求失败，尝试次数: x - 重试信息
收到客户端刷新鉴权请求 - 客户端通信
处理鉴权请求: xxx - 请求处理
```

#### 网络请求检查
1. 打开浏览器开发者工具
2. 切换到「Network」标签
3. 刷新页面，观察静态资源请求
4. 检查请求URL是否包含正确的鉴权参数
5. 查看响应状态码和错误信息

## 📊 性能优化

### 建议配置

- **鉴权有效期**: 30-60分钟，平衡安全性和性能
- **检查间隔**: 5分钟，避免过于频繁的检查
- **重试次数**: 3次，避免无限重试
- **文件类型**: 只对必要的文件类型启用鉴权

### 性能影响

- **CPU使用**: 定期检查会有轻微的CPU开销
- **内存使用**: Service Worker会占用少量内存
- **网络请求**: 重试机制可能增加网络请求
- **页面加载**: 首次加载时可能有轻微延迟

## 📈 版本历史

### v1.1.0 (最新版本)
- ✨ 新增客户端自动刷新机制
- 🔧 增强Service Worker错误处理
- 🐛 修复插件禁用后仍然工作的问题
- 📝 完善文档和调试信息
- 🚀 提升用户体验和稳定性

### v1.0.0
- 🎉 初始版本发布
- 🔐 基础URL鉴权功能
- 🌐 Service Worker支持
- ⚙️ 多域名配置支持

## ⚠️ 注意事项

### 环境要求
- **Typecho版本**: 1.0及以上
- **PHP版本**: 7.0及以上
- **浏览器要求**: 支持Service Worker的现代浏览器
- **HTTPS要求**: 生产环境需要HTTPS（Service Worker限制）

### 安全建议
- 定期更换鉴权密钥
- 设置合适的鉴权有效期
- 监控异常访问日志
- 及时更新插件版本

### 兼容性
- 与大部分Typecho主题兼容
- 支持响应式设计
- 兼容主流CDN服务
- 支持多种文件类型

## 🆘 技术支持

### 获取帮助
- **问题反馈**: 请提供详细的错误信息和环境配置
- **功能建议**: 欢迎提出改进建议
- **技术交流**: 分享使用经验和最佳实践

### 调试技巧
1. 启用浏览器开发者工具
2. 查看控制台日志信息
3. 检查网络请求状态
4. 验证鉴权参数格式
5. 测试多吉云控制台配置

## 📄 许可证

本插件采用 MIT 许可证发布，允许自由使用、修改和分发。

> 💡 **提示**: 如果您在使用过程中遇到问题，请先查看故障排除部分，或查看浏览器控制台的调试信息。