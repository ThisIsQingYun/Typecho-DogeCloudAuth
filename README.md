# 多吉云URL鉴权插件

## 简介

多吉云URL鉴权插件是一个专为Typecho博客系统设计的插件，用于为多吉云CDN提供URL鉴权功能，有效防止资源盗链和恶意访问。

**本人博客: [氢云小屋](https://www.uomn.cn)**

## 功能特性

- ✅ **自动鉴权**: 自动为页面中的静态资源添加鉴权参数
- ✅ **多域名支持**: 支持配置多个域名和对应的密钥
- ✅ **灵活配置**: 可自定义鉴权参数名和有效期
- ✅ **文件类型过滤**: 支持指定需要鉴权的文件扩展名
- ✅ **Service Worker**: 支持处理AJAX请求和动态加载的资源
- ✅ **安全性**: 采用时间戳+签名的鉴权方式，密钥在客户端进行混淆处理
- ✅ **兼容性**: 兼容多吉云以及部分其他厂商的CDN鉴权机制

## 安装方法

1. 将插件文件夹 `DogeCloudAuth` 上传到 Typecho 的 `usr/plugins/` 目录下
2. 在 Typecho 后台的「控制台」->「插件」中找到「多吉云URL鉴权插件」
3. 点击「启用」按钮激活插件
4. 点击「设置」按钮进行配置

## 配置说明

### 基本配置

#### 域名与密钥配置
```
cdn.example.com:your_secret_key_1
static.example.com:your_secret_key_2
```
- 每行一个域名与密钥的对应关系
- 格式：`域名:密钥`
- 密钥可在多吉云控制台的密钥管理中获取

#### 链接有效期
- 单位：秒
- 默认：1800秒（30分钟）
- 建议根据实际需求调整，过短可能影响用户体验，过长可能降低安全性

#### 需要鉴权的文件扩展名
```
.jpg;.jpeg;.png;.gif;.webp;.css;.js;.mp4;.mp3;.pdf;.zip
```
- 用分号分隔
- 支持常见的图片、样式、脚本、视频、音频等文件类型

#### 鉴权参数配置
- **鉴权参数名**: 默认为 `auth_key`（多吉云），也可选择 `sign`（通用标准）
- **说明**: 鉴权参数名需要根据不同厂商进行变化，理论上大多数厂商的鉴权参数名就是这两个之一，但是也有一些厂商的鉴权参数名是其他的，需要根据实际情况进行修改



### 高级配置

#### Service Worker
- 启用后可以处理AJAX请求和动态加载的资源
- 建议在现代浏览器环境下启用
- 如果网站主要面向老旧浏览器，可以禁用

## 鉴权原理

### 签名算法（多吉云标准格式）

插件采用多吉云标准的鉴权算法：

1. **auth_key格式**: `timestamp-rand-uid-md5hash`
2. **签名字符串构造**: `path-timestamp-rand-uid-secretKey`
3. **哈希计算**: `md5hash = MD5(signString)`
4. **URL构造**: `原URL?auth_key=timestamp-rand-uid-md5hash`

### 参数说明

- **timestamp**: 链接失效时间的Unix时间戳
- **rand**: 随机字符串（1-100位，支持大小写字母和数字）
- **uid**: 用户ID，默认为0
- **md5hash**: MD5哈希值，由path-timestamp-rand-uid-密钥计算得出

### 示例

原始URL：
```
https://www.example.com/test/a.jpg
```

鉴权后URL：
```
https://www.example.com/test/a.jpg?auth_key=1582638821-HRtzwh43en96cih4ZBk67ePCU4esNPGx-0-4a98a6d76ca0acc83469b6
```

计算过程：
- **path**: `/test/a.jpg`
- **timestamp**: `1582638821`
- **rand**: `HRtzwh43en96cih4ZBk67ePCU4esNPGx`
- **uid**: `0`
- **签名字符串**: `/test/a.jpg-1582638821-HRtzwh43en96cih4ZBk67ePCU4esNPGx-0-DogeCloudCDNTestDogeCloudCDNTest`
- **md5hash**: `4a98a6d76ca0acc83469b68612551aa3`

## 多吉云配置

在多吉云控制台需要配置相应的URL鉴权规则：

1. 登录多吉云控制台
2. 进入CDN管理 -> 域名管理
3. 选择对应域名，进入配置页面
4. 找到「URL鉴权」或「防盗链」设置
5. 配置鉴权规则，确保与插件配置一致

## 安全建议

1. **密钥安全**: 定期更换密钥，避免密钥泄露
2. **时间同步**: 确保服务器时间准确，避免鉴权失效
3. **HTTPS**: 建议使用HTTPS协议，保护传输安全
4. **访问控制**: 结合其他安全措施，如IP白名单等

## 许可证

本插件遵循 MIT 许可证，允许自由使用、修改和分发。

## 免责声明


本插件仅供学习和研究使用，使用者需要自行承担使用风险。开发者不对因使用本插件而导致的任何损失承担责任。



